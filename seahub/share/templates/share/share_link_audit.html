{% extends "base.html" %}
{% load i18n %}

{% block main_panel %}
<div class="new-narrow-panel" role="main">
    <h2 class="hd">{% trans "Email verification" %}</h2>
    <p class="notice">{% trans "Please provide your email address to continue." %}</p>

    <form action="#" method="post" id="link-audit-form" class="con link-visit-verify">{% csrf_token %}
        <label for="email">{% trans "Email" %}</label>
        <input id="email" type="text" class="input" name="email" value="{{email}}" />
        <button id="code-btn">{% trans "Get code" %}</button><br/>
        <p class="field-feedback"></p>

        <lable for="code">{% trans "Verification code" %}</lable>
        <input id="code" type="text" class="input" name="code" value="{{code}}" /><br/>

        {% if err_msg %}
        <p class="error">{{ err_msg }}</p>
        {% endif %}

        <input type="submit" value="{% trans "Submit" %}" />
    </form>
</div>
{% endblock %}
{% block extra_script %}
<script type="text/javascript">
$('#code-btn').click(function() {
    var email = $('input[name="email"]').val();
    if (!email) {
        return false;
    }

    var $this = $(this);
    var originalText = this.innerHTML;  // Remember the original text content
    var seconds = 60;

    $this.prop('disabled', true).addClass('btn-disabled');
    $this.text(originalText + '(' + seconds + 's)');
    // do a set interval, using an interval of 1000 milliseconds
    //     and clear it after the number of seconds counts down to 0
    var interval = setInterval(function() {
        // decrement the seconds and update the text
        seconds = seconds - 1;
        $this.text( originalText + ' (' + seconds + 's)');
        if (seconds === 0) {  // once seconds is 0...
            $this.prop('disabled', false).removeClass('btn-disabled')
                 .text(originalText);   //reset to original text
            clearInterval(interval);  // clear interval
        }
    }, 1000);

    $.ajax({
        url: "{% url "ajax_get_link_audit_code" %}",
        type: 'POST',
        cache: 'false',
        beforeSend: prepareCSRFToken,
        data: {
            token: "{{token}}",
            email: email
        },
        success: function() {
            $(".field-feedback").html('{% trans "Successfully sent verification code to this email." %}');
        },
        error: function(jqXHR, textStatus, errorThrown) {
            $(".field-feedback").html($.parseJSON(jqXHR.responseText).error);
        }
    });

    return false;
});

</script>
{% endblock %}
