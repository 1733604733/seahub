{% extends "myhome_base.html" %}
{% load seahub_tags %}

{% block main_panel %}
{% if not cloud_mode or not no_quota %}
<div class="narrow-panel">
    <h3>更新文件
            {% for name, link in zipped %}
              {% if not forloop.last %}
                <a href="{{ SITE_ROOT }}repo/{{ repo.id }}/?p={{ link|urlencode }}">{{ name }}</a> / 
              {% else %}
                {{ name }}
              {% endif %}
            {% endfor %}
    </h3>
    <form id="upload-file-form" enctype="multipart/form-data" method="post" action="{{ update_url }}">
        <input type="hidden" name="target_file" value="{{ target_file }}" />
        <input type="file" name="file" id="file" />
        <p>(文件应小于 {{ max_upload_file_size|filesizeformat }})</p>
        <p id="error-msg" class="error">{{ error_msg }}</p>
        <input id="upload-submit" type="submit" value="提交" class="submit" />
    </form>
    
    <div id="upload-progress" class="hide">
        <p>上传进度: <span id="upload-progress-text">获取中，请稍侯...</span></p>
        <div id="task-progress-bar" class="hide"></div>
        <button id="upload-cancel">取消</button>
    </div>
    <iframe id="request-progress" class="hide"><!--for chrome--></iframe>
</div>
{% else %}
<div class="text-panel">
    <p class="error">该同步目录所有者的空间已用完，无法更新</p>
</div>
{% endif %}
{% endblock %}

{% block extra_script %}
{% if not cloud_mode or not no_quota %}
<script type="text/javascript">
function gen_uuid() {
    var uuid = "";
    for (var i=0; i < 32; i++) {
        uuid += Math.floor(Math.random() * 16).toString(16); 
    }
    return uuid;
}

function submit_and_real_time_show () {
    var form = $('#upload-file-form')[0],
        uuid = gen_uuid(); // id for this upload so we can fetch progress info.
    $('#upload-progress').removeClass('hide');

    // Append X-Progress-ID uuid form action
    form.action += (form.action.indexOf('?') == -1 ? '?' : '&') + 'X-Progress-ID=' + uuid;
    form.submit();
    $('#upload-submit').addClass('hide');

    // Update progress bar: not work in chrome. for ff.
    function update_progress_info() {
        $.ajax({
            url: '{{ httpserver_root }}/upload_progress/?X-Progress-ID=' + uuid + '&callback=?', 
            dataType: 'jsonp',
            cache: false,
            success: function(data) {
                if (data) {
                    $('#upload-progress-text').html(filesizeformat(data.uploaded) + ' / ' +  filesizeformat(data.length));
                    $('#task-progress-bar').removeClass('hide').progressbar({
                            value: data.uploaded / data.length * 100
                    });
                }
            }
        });
        setTimeout(update_progress_info, 1000);
    };
    update_progress_info();

    // Update progress bar: for chrome 
    $('#request-progress').attr('src', '{{ SITE_ROOT }}file_upload_progress_page/?uuid=' + uuid);

    return false;
};

$('#upload-submit').click(function () {
    if (!$.trim($('#file').val())) {
        $('#error-msg').html('请先选择一个文件');
        return false;
    }
    $('#error-msg').addClass('hide');
    submit_and_real_time_show();
    return false;
});

$('#upload-cancel').click(function() {
    location.reload(true);
});
</script>
{% endif %}
{% endblock %}
