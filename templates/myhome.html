{% extends "myhome_base.html" %}
{% load seahub_tags avatar_tags group_avatar_tags %}
{% load url from future %}

{% block nav_myhome_class %}class="cur"{% endblock %}

{% block left_panel %}
<h3>我的基本信息</h3>
<div class="home-profile w100 ovhd">
    <a href="{{ SITE_ROOT }}profile/" class="no-deco">{% avatar myname 48 %}</a>
{% if nickname %}
<p class="fleft">{{ nickname }}</p>
{% else %}
<p class="fleft">暂无昵称 <a href="{{ SITE_ROOT }}profile/"><img src="{{ MEDIA_URL }}img/edit_12.png" alt="编辑" title="编辑" /></a></p>
{% endif %}
</div>

{% if grpmsg_list or grpmsg_reply_list or orgmsg_list %}
<h3>提醒...</h3>
<ul>
{% if grpmsg_list %}
<li>
    群组
    {% for grp in grpmsg_list %}
    <a href="{% url 'group_info' grp.id %}" class="no-bold">{{ grp.group_name }}</a> 
    {% endfor %}
    有新留言
</li>
{% endif %}
{% if grpmsg_reply_list %}
<li><a href="{{ SITE_ROOT }}group/reply/new/" class="no-bold">{{ grpmsg_reply_list|length }}条群组留言有新回复</a></li>
{% endif %}
{% if orgmsg_list %}
<li><a href="{% url 'org_msg' %}" class="no-bold">{{ orgmsg_list|length }}条团体消息</a></li>
{% endif %}
</ul>
{% endif %}

<h3>已用空间</h3>
<p>{{ quota_usage|filesizeformat }} {% if cloud_mode %}/ 2 GB {% endif %}</p>

<!-- 我的群组 -->
{% with groups=joined_groups %}
{% include "snippets/my_groups.html" %}
{% endwith %}
{% endblock %}

{% block right_panel %}
<!-- 我拥有的同步目录 -->
{% include "snippets/my_owned_repos.html" %}

<!-- 共享给我的同步目录 -->
{% include "snippets/shared_in_repos.html" %}

{% if events %}
<h3>最近事件</h3>
<ul id="events" class="hide">
{% for ev in events %}
    <li class="event-item w100 ovhd">
    {% if ev.etype == 'repo-update' %}
        {% with author=ev.commit.creator_name commit=ev.commit repo=ev.repo %}
        <div class="pic fleft" data="{{ author }}">
            <a href="{% url 'user_profile' author %}" title="{{ author|email2nickname}}">{% avatar author 40 %}</a>
        </div>
        <div class="txt fright">
            <div class="event-hd">
                <span class="time">{{ commit.ctime|translate_commit_time }}</span>
                <a href="{% url 'user_profile' author %}" title="{{ author|email2nickname}}">{{ author|email2nickname }}</a>
            </div>
            <p>更新了目录 <a href="{{SITE_ROOT}}repo/{{repo.id}}">{{ repo.name }}</a> <a class="lsch" href="{{ SITE_ROOT }}repo/history/changes/{{ repo.id }}/?commit_id={{ commit.id }}" data="{{ commit.props.ctime|tsstr_sec }}">详情</a></P>
        </div>
        {% endwith %}
    {% endif %}
     
    {% if ev.etype == 'repo-create' %}
        {% with author=ev.creator repo_id=ev.repo_id repo_name=ev.repo_name %}
        <div class="pic fleft" data="{{ author }}">
            <a href="{% url 'user_profile' author %}" title="{{ author|email2nickname}}">{% avatar author 40 %}</a>
        </div>
        <div class="txt fright">
            <div class="event-hd">
                <span class="time">{{ ev.timestamp|translate_commit_time }}</span>
                <a href="{% url 'user_profile' author %}" title="{{ author|email2nickname}}">{{ author|email2nickname }}</a>
            </div>
            <p>创建了目录 <a href="{{SITE_ROOT}}repo/{{repo_id}}">{{ repo_name }}</a></p>
        </div>
        {% endwith %}
    {% endif %}

    {% if ev.etype == 'repo-delete' %}
        {% with author=ev.repo_owner repo_name=ev.repo_name %}
        <div class="pic fleft" data="{{ author }}">
            <a href="{% url 'user_profile' author %}" title="{{ author|email2nickname}}">{% avatar author 40 %}</a>
        </div>
        <div class="txt fright">
            <div class="event-hd">
                <span class="time">{{ ev.timestamp|translate_commit_time }}</span>
                <a href="{% url 'user_profile' author %}" title="{{ author|email2nickname}}">{{ author|email2nickname }}</a>
            </div>
            <p>删除了目录 {{ repo_name }}</p>
        </div>
        {% endwith %}
    {% endif %}
    </li>
{% endfor %}
</ul>
<div id="ls-ch" class="hide"></div><!--list modification details of a commit-->
{% endif %}

{% url 'share_repo' as repo_share_url %}
{% with post_url=repo_share_url tips='' %}
{% include "snippets/repo_share_form.html" %}
{% endwith %}

{% include "snippets/repo_create_form.html" %}
{% endblock %}

{% block extra_script %}
<script type="text/javascript">
{% include "snippets/myhome_extra_script.html" %}
   
{% url 'seahub.views.repo_create' as repo_create_url %}
{% with post_url=repo_create_url %}
{% include "snippets/repo_create_js.html" %}
{% endwith %}

{% if events %}
{% include 'snippets/list_commit_detail.html' %}
$('.event-item').each(function(index) {
    if (index > 0 && $(this).children('.pic').attr('data') == $(this).prev().children('.pic').attr('data')) {
        $(this).children('.pic').addClass('hide');
    }
});
$('#events').removeClass('hide');
{% endif %}
</script>
{% endblock %}
