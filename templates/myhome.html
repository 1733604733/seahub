{% extends "myhome_base.html" %}
{% load seahub_tags avatar_tags group_avatar_tags %}

{% block nav_myhome_class %}class="cur"{% endblock %}
{% block left_panel %}

<h3>我的基本信息</h3>
<div class="home-profile w100 ovhd">
{% avatar myname 48 %}
{% if nickname %}
<p class="fleft">{{ nickname }}</p>
{% else %}
<p class="fleft">暂无昵称 <a href="{{ SITE_ROOT }}profile/"><img src="{{ MEDIA_URL }}img/edit_12.png" alt="编辑" title="编辑" /></a></p>
{% endif %}
</div>

{% if grpmsg_reply_list %}
<span class="new-reply"><a href="{{ SITE_ROOT }}group/reply/new/">{{ grpmsg_reply_list|length }}条留言有新回复</a></span>
{% endif %}

<h3>已用空间</h3>
<p>{{ quota_usage|filesizeformat }} / 2 GB</p>

{% if request.user.org %}
<h3>所属企业</h3>
<p>{{ request.user.org.org_name }}</p>
{% endif %}

<h3>我管理的小组</h3>
{% if groups_manage %}
<ul>
    {% for group in groups_manage %}
    <li class="mygroup">
    <a href="{{ SITE_ROOT }}group/{{ group.props.id }}/">
        <img src="{% grp_avatar_url group.props.id 48 %}" alt="{{ group.props.group_name }}的图标" title="{{ group.props.group_name }}" />
    </a><br />
	<a href="{{ SITE_ROOT }}group/{{ group.props.id }}/">{{ group.props.group_name }}</a>
        {% if group.new_msg %}
        <span class="tips">（新留言）</span>
        {% endif %}
	</li>
    {% endfor %}
</ul>
{% else %}
<p>暂无</p>
{% endif %}

<h3>我参加的小组</h3>
{% if groups_join %}
<ul>
	{% for group in groups_join %}
    <li class="mygroup">
    <a href="{{ SITE_ROOT }}group/{{ group.props.id }}/">
        <img src="{% grp_avatar_url group.props.id 48 %}" alt="{{ group.props.group_name }}的图标" title="{{ group.props.group_name }}" />
    </a><br />
	<a href="{{ SITE_ROOT }}group/{{ group.props.id }}/">{{ group.props.group_name }}</a>
        {% if group.new_msg %}
        <span class="tips">（新留言）</span>
        {% endif %}
	</li>
	{% endfor %}
</ul>
{% else %}
<p>暂无</p>
{% endif %}

{% endblock %}


{% block right_panel %}
{% if messages %}
<ul class="messages">
  {% for message in messages %}
  {% if message.tags == 'info' %}
  <li class="notification">共享给 {{ message }} 成功，请前往<a href="{{ SITE_ROOT }}shareadmin/">共享管理</a>查看。</li>  
  {% endif %}
  {% if message.tags == 'error' %}
  <li class="error">共享给 {{ message }} 失败</li>  
  {% endif %}
  {% endfor %}
  
</ul>
{% endif %}

{% if output_msg %}
    {% for key, value in output_msg.items %}
        {% if key == 'info_msg' %}
<p class="notification">{{ value }} 请前往<a href="{{ SITE_ROOT }}shareadmin/">共享管理</a>查看。</p>
        {% endif %}
        {% if key == 'err_msg' %}
<p class="error">{{ value }}</p>
        {% endif %}
    {% endfor %}
{% endif %}

<div class="w100 ovhd">
    <h3 class="fleft">我拥有的同步目录</h3>
    <a id="repo-create" class="fright" href="#">新建同步目录</a>
</div>

{% if owned_repos %}
<table>
    <tr>
        <th width="25%">名字</th>
        <th width="43%">描述</th>
        <th width="20%">更新时间</th>
        <th width="12%">操作</th>
    </tr>

    {% for repo in owned_repos %}
    <tr>
        <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}/">{{ repo.props.name }}</a></td>
        <td>{{ repo.props.desc }}</td>
        {% if repo.latest_modify %}
        <td>{{ repo.latest_modify|translate_commit_time }}</td>
        {% else %}
        <td>—— ——</td>
        {% endif %}
        <td>
            <img src="{{ MEDIA_URL }}img/download-20.png" data="{{ repo.props.id }}" class="download-btn vh" title="下载" alt="下载" />
            <img src="{{ MEDIA_URL }}img/share-20.png" data="{{ repo.props.id }}" class="repo-share-btn vh" title="共享" alt="共享" />
            <img src="{{ MEDIA_URL }}img/delete-20.png" data="{{ SITE_ROOT }}repo/remove/{{ repo.props.id }}/?next={{ request.path }}" class="repo-delete-btn vh" title="删除" alt="删除" />
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>暂无</p>
{% endif %}

<h3>共享给我的同步目录</h3>
{% if in_repos %}
<table>
    <tr>
        <th width="25%">名字</th>
        <th width="20%">共享来源</th>
        <th width="25%">描述</th>
        <th width="20%">更新时间</th>
        <th width="10%">操作</th>
    </tr>

    {% for repo in in_repos %}
    <tr>
        <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}">{{ repo.props.name }}</a></td>
        <td>{{ repo.props.shared_email }}</td>
        <td>{{ repo.props.desc }}</td>
        {% if repo.latest_modify %}
        <td>{{ repo.latest_modify|translate_commit_time }}</td>
        {% else %}
        <td>—— ——</td>
        {% endif %}
        <td>
            <img src="{{ MEDIA_URL }}img/download-20.png" data="{{ repo.props.id }}" class="download-btn vh" title="下载" alt="下载" />
            <img src="{{ MEDIA_URL }}img/delete-20.png" data="{{ SITE_ROOT }}shareadmin/removeshare/?repo_id={{ repo.id }}&from={{ repo.shared_email }}&to={{ request.user }}" class="unshare-btn vh" title="取消共享" alt="取消共享" />
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>暂无</p>
{% endif %}

<form id="repo-share-form" action="{{ SITE_ROOT }}share/add/" method="post" name="repo-share-form" class="hide">
    <label>邮箱或小组：</label><br />
    <textarea id="email_or_group" name="email_or_group"></textarea>
    <input id="repo_id" type="hidden" name="repo_id" value="" />
    <p class="tip">可以是非网站注册用户，我们会以邮件通知对方。</p>
    <p class="error hide">输入不能为空。</p>
    <input type="submit" value="提交" id="share-submit-btn" />
</form>

<form id="repo-create-form" action="{{ SITE_ROOT }}repo/create/" method="post" class="hide">
    <h3>新建同步目录</h3>
    <label>名称：</label><br/>
    <input id="repo-name" type="text" name="repo_name" value="" /><br />
    <label>描述：</label><br/>
    <textarea id="repo-desc" name="repo_desc"></textarea>
    <div class="repo-create-encryption">
        <input type="checkbox" name="encryption" id="encrypt-switch" /><label>加密</label><br />
        <label>密码：</label><span class="tip">(3到15个字符)</span><br />
        <input type="password" name="passwd" disabled="disabled" class="passwd input-disabled" /><br />
        <label>密码确认：</label><br />
        <input type="password" name="passwd_again" disabled="disabled" class="passwd input-disabled" />
    </div>
    <p class="error hide"></p>
    <input type="submit" id="repo-create-submit" value="提交" class="submit" />
</form>

{% endblock %}

{% block extra_script %}
<script type="text/javascript">
$(function() {
    //repo-share-form share-list autocomplete
    var share_list = [];
    {% for contact in contacts %}
    share_list.push('{{ contact.contact_email }}');
    {% endfor %}

    {% for group in groups %}
    share_list.push('{{ group.props.group_name }} <{{ group.props.creator_name }}>');
    {% endfor %}

    $(".repo-share-btn").click(function() {
        $("#repo_id").val($(this).attr("data"));
        $("#repo-share-form").modal({appendTo: "#main"});
        addAutocomplete('#email_or_group', '#repo-share-form', share_list);
    });

    //check before post
    $('#share-submit-btn').click(function() {
        if (!$.trim($('#email_or_group').attr('value'))) {
            $('#repo-share-form .error').removeClass('hide');
            $('#simplemodal-container').css('height', $('#repo-share-form').height());
            return false;
        }
    });

    addConfirmTo($('.repo-delete-btn'));
    
    addConfirmTo($('.unshare-btn'), '确定要取消共享？');

    $(".download-btn").click(function() {
            window.open('{{ SITE_ROOT }}seafile_access_check/?repo_id=' + $(this).attr('data'));
       });

//show op images when mouse hover on
    $("table tr:gt(0)").hover(
        function() {
            $(this).find('img').css('cursor', 'pointer').removeClass('vh');
        },
        function() {
            $(this).find('img').addClass('vh');
        }
    );
});

//repo-create-form
$('#repo-create').click(function() {
    $('#repo-create-form').modal({appendTo: '#main', autoResize: true});
    return false;
});
$('#encrypt-switch').click(function () {
    if ($(this).attr('checked')) {
        $('#repo-create-form input[type="password"]').attr('disabled', false).removeClass('input-disabled');
    } else {
        $('#repo-create-form input[type="password"]').attr('disabled', true).addClass('input-disabled');
    }
});
function showError(err) {
    $('#repo-create-form .error').html(err).attr('class','error');
    $('#simplemodal-container').css('height', $('#repo-create-form').height());
}
$('#repo-create-submit').click(function() {
    var passwd = $('#repo-create-form input[name="passwd"]'),
        passwd_again = $('#repo-create-form input[name="passwd_again"]');

    if (!$('#repo-name').val()) {
        showError('目录名不能为空。');
        return false;
    }
     if (!$('#repo-desc').val()) {
        showError('描述不能为空。');
        return false;
    }   

    if ($('#encrypt-switch').attr('checked')) {
        if (!passwd.val()) {
            showError('密码不能为空。');
            return false;
        }   
        if (!passwd_again.val()) {
            showError('请确认密码。');
            return false;
        }   
        if (passwd.val().length < 3) {
            showError('密码太短。');
            return false;
        }
        if (passwd.val().length > 15) {
            showError('密码太长。');
            return false;
        }
        if (passwd.val() != passwd_again.val()) {
            showError('两次输入的密码不一致。');
            return false;
        }
    }

    // prepare django csrf token
    $.ajaxSetup({ 
        beforeSend: function(xhr, settings) {
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '='))        {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                // Only send the token to relative URLs i.e. locally.
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
        } 
    }); 

    $.ajax({
        url: '{{ SITE_ROOT }}repo/create/',
        type: 'POST',
        dataType: 'json',
        cache: 'false',
        contentType: 'application/json; charset=utf-8',
        data: {
            'repo_name': $('#repo-name').val(),
            'repo_desc': $('#repo-desc').val(),
            'encryption': $('#encrypt-switch').attr('checked') ? 1 : 0,
            'passwd': passwd.val(),
            'passwd_again': passwd_again.val()
        },
        success: function(data) {
            if (data['success']) {
                location.reload(true);
            } else {
                showError(data['error']);
            }
        }
    });

    return false;
});
</script>
{% endblock %}
