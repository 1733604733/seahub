{% extends "myhome_base.html" %}
{% load avatar_tags %}

{% block nav_myhome_class %}class="cur"{% endblock %}
{% block left_panel %}

<h3>已用空间</h3>
<p>{{ quota_usage|filesizeformat }} / 2 GB</p>

<h3>我管理的小组</h3>
{% if groups_manage %}
<ul>
    {% for group in groups_manage %}
    <li class="mygroup">
	<a href="{{ SITE_ROOT }}group/{{ group.props.id }}/"><img src="{{ MEDIA_URL }}img/group.jpg" alt="" /></a><br />
	<a href="{{ SITE_ROOT }}group/{{ group.props.id }}/">{{ group.props.group_name }}</a>
	</li>
    {% endfor %}
</ul>
{% else %}
<p>暂无</p>
{% endif %}

<h3>我参加的小组</h3>
{% if groups_join %}
<ul>
	{% for group in groups_join %}
    <li class="mygroup">
	<a href="{{ SITE_ROOT }}group/{{ group.props.id }}/"><img src="{{ MEDIA_URL }}img/group.jpg" alt="" /></a><br />
	<a href="{{ SITE_ROOT }}group/{{ group.props.id }}/">{{ group.props.group_name }}</a>
	</li>
	{% endfor %}
</ul>
{% else %}
<p>暂无</p>
{% endif %}

{% endblock %}


{% block right_panel %}
{% if output_msg %}
    {% for key, value in output_msg.items %}
        {% if key == 'info_msg' %}
<p class="notification">{{ value }} 请前往<a href="{{ SITE_ROOT }}shareadmin/">共享管理</a>查看。</p>
        {% endif %}
        {% if key == 'err_msg' %}
<p class="error">{{ value }}</p>
        {% endif %}
    {% endfor %}
{% endif %}

<h3>我拥有的同步目录</h3>
{% if owned_repos %}
<table>
    <tr>
        <th width="34%">名字</th>
        <th width="54%">描述</th>
        <th width="12%">操作</th>
    </tr>

    {% for repo in owned_repos %}
    <tr>
        <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}/">{{ repo.props.name }}</a></td>
        <td>{{ repo.props.desc }}</td>
        <td>
            <img src="{{ MEDIA_URL }}img/download-20.png" data="{{ repo.props.id }}" class="download-btn vh" title="下载" alt="下载" />
            <img src="{{ MEDIA_URL }}img/share-20.png" data="{{ repo.props.id }}" class="repo-share-btn vh" title="共享" alt="共享" />
            <img src="{{ MEDIA_URL }}img/delete-20.png" data="{{ SITE_ROOT }}repo/remove/{{ repo.props.id }}/" class="repo-delete-btn vh" title="删除" alt="删除" />
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>暂无</p>
{% endif %}

<h3>共享给我的同步目录</h3>
{% if in_repos %}
<table>
    <tr>
        <th width="25%">名字</th>
        <th width="20%">共享来源</th>
        <th width="35%">描述</th>
        <th width="20%">操作</th>
    </tr>

    {% for repo in in_repos %}
    <tr>
        <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}">{{ repo.props.name }}</a></td>
        <td>{{ repo.props.shared_email }}</td>
        <td>{{ repo.props.desc }}</td>
        <td>
            <img src="{{ MEDIA_URL }}img/download-20.png" data="{{ repo.props.id }}" class="download-btn vh" title="下载" alt="下载" />
            <img src="{{ MEDIA_URL }}img/delete-20.png" data="{{ SITE_ROOT }}shareadmin/removeshare/?repo_id={{ repo.id }}&from={{ repo.shared_email }}&to={{ request.user }}" class="unshare-btn vh" title="取消共享" alt="取消共享" />
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>暂无</p>
{% endif %}

<form id="repo-share-form" action="{{ SITE_ROOT }}home/my/" method="post" name="repo-share-form" class="hide">
    <label>邮箱或小组：</label><br />
    <textarea id="to_email" name="to_email"></textarea><br />
    <input id="share_repo_id" type="hidden" name="share_repo_id" value="" />
    <p class="error hide">输入不能为空。</p>
    <input type="submit" value="提交" id="share-submit-btn" />
</form>

{% endblock %}

{% block extra_script %}
<script type="text/javascript">
$(function() {
    //repo-share-form share-list autocomplete
    var share_list = [];
    {% for contact in contacts %}
    share_list.push('{{ contact.contact_email }}');
    {% endfor %}

    {% for group in groups %}
    share_list.push('{{ group.props.group_name }} <{{ group.props.creator_name }}>');
    {% endfor %}

    $(".repo-share-btn").click(function() {
        $("#share_repo_id").val($(this).attr("data"));
        $("#repo-share-form").modal({appendTo: "#main"});
        addAutocomplete('#to_email', '#repo-share-form', share_list);
    });

    //check before post
    $('#share-submit-btn').click(function() {
        if (!$.trim($('#to_email').attr('value'))) {
            $('#repo-share-form .error').removeClass('hide');
            return false;
        }
        return true;
    });

    addConfirmTo($('.repo-delete-btn'));
    
    addConfirmTo($('.unshare-btn'), '确定要取消共享？');

    $(".download-btn").click(function() {
            window.open('{{ SITE_ROOT }}seafile_access_check/?repo_id=' + $(this).attr('data'));
       });

//show op images when mouse hover on
    $("table tr:gt(0)").hover(
        function() {
            $(this).addClass('hl');
            $(this).find('img').css('cursor', 'pointer').removeClass('vh');
        },
        function() {
            $(this).removeClass('hl');
            $(this).find('img').addClass('vh');
        }
    );
});
</script>
{% endblock %}
