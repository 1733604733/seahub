{% extends "myhome_base.html" %}
{% load seahub_tags avatar_tags group_avatar_tags %}

{% block nav_myhome_class %}class="cur"{% endblock %}
{% block left_panel %}

<h3>我的基本信息</h3>
<div class="home-profile w100 ovhd">
    <a href="{{ SITE_ROOT }}profile/" class="no-deco">{% avatar myname 48 %}</a>
{% if nickname %}
<p class="fleft">{{ nickname }}</p>
{% else %}
<p class="fleft">暂无昵称 <a href="{{ SITE_ROOT }}profile/"><img src="{{ MEDIA_URL }}img/edit_12.png" alt="编辑" title="编辑" /></a></p>
{% endif %}
</div>

{% if grpmsg_reply_list %}
<span class="new-reply"><a href="{{ SITE_ROOT }}group/reply/new/">{{ grpmsg_reply_list|length }}条留言有新回复</a></span>
{% endif %}
{% if orgmsg_list %}
<span class="new-reply"><a href="{% url org_msg %}">你有{{ orgmsg_list|length }}条团体消息</a></span>
{% endif %}

<h3>已用空间</h3>
<p>{{ quota_usage|filesizeformat }} / 2 GB</p>

<h3>我管理的小组</h3>
{% if groups_manage %}
<ul>
    {% for group in groups_manage %}
    <li class="mygroup">
    <a href="{{ SITE_ROOT }}group/{{ group.props.id }}/" class="no-deco">
        <img src="{% grp_avatar_url group.props.id 48 %}" alt="{{ group.props.group_name }}的图标" title="{{ group.props.group_name }}" class="avatar" />
    </a><br />
	<a href="{{ SITE_ROOT }}group/{{ group.props.id }}/">{{ group.props.group_name }}</a>
        {% if group.new_msg %}
        <span class="tips">（新留言）</span>
        {% endif %}
	</li>
    {% endfor %}
</ul>
{% else %}
<p>暂无</p>
{% endif %}

<h3>我参加的小组</h3>
{% if groups_join %}
<ul>
	{% for group in groups_join %}
    <li class="mygroup">
    <a href="{{ SITE_ROOT }}group/{{ group.props.id }}/" class="no-deco">
        <img src="{% grp_avatar_url group.props.id 48 %}" alt="{{ group.props.group_name }}的图标" title="{{ group.props.group_name }}" class="avatar" />
    </a><br />
	<a href="{{ SITE_ROOT }}group/{{ group.props.id }}/">{{ group.props.group_name }}</a>
        {% if group.new_msg %}
        <span class="tips">（新留言）</span>
        {% endif %}
	</li>
	{% endfor %}
</ul>
{% else %}
<p>暂无</p>
{% endif %}

{% endblock %}


{% block right_panel %}
{% if messages %}
<ul class="messages">
  {% for message in messages %}
  {% if message.tags == 'info' %}
  <li class="notification">共享给 {{ message }} 成功，请前往<a href="{{ SITE_ROOT }}shareadmin/">共享管理</a>查看。</li>  
  {% endif %}
  {% if message.tags == 'error' %}
  <li class="error">共享给 {{ message }} 失败</li>  
  {% endif %}
  {% endfor %}
  
</ul>
{% endif %}

{% if output_msg %}
    {% for key, value in output_msg.items %}
        {% if key == 'info_msg' %}
<p class="notification">{{ value }} 请前往<a href="{{ SITE_ROOT }}shareadmin/">共享管理</a>查看。</p>
        {% endif %}
        {% if key == 'err_msg' %}
<p class="error">{{ value }}</p>
        {% endif %}
    {% endfor %}
{% endif %}

<h3>我拥有的同步目录</h3>
<button id="repo-create">新建同步目录</button>
<table>
    <tr>
        <th width="25%">名字</th>
        <th width="43%">描述</th>
        <th width="20%">更新时间</th>
        <th width="12%">操作</th>
    </tr>
{% if owned_repos %}
    {% for repo in owned_repos %}
    <tr>
        <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}/">{{ repo.props.name }}</a></td>
        <td>{{ repo.props.desc }}</td>
        {% if repo.latest_modify %}
        <td>{{ repo.latest_modify|translate_commit_time }}</td>
        {% else %}
        <td>—— ——</td>
        {% endif %}
        <td>
            <img src="{{ MEDIA_URL }}img/sync-20.png" data="{{ repo.props.id }}" class="download-btn vh" title="同步到本地" alt="同步" />
            <img src="{{ MEDIA_URL }}img/share-20.png" data="{{ repo.props.id }}" class="repo-share-btn vh" title="共享" alt="共享" />
            <img src="{{ MEDIA_URL }}img/delete-20.png" data="{{ SITE_ROOT }}repo/remove/{{ repo.props.id }}/?next={{ request.path }}" class="repo-delete-btn vh" title="删除" alt="删除" />
        </td>
    </tr>
    {% endfor %}
{% endif %}
</table>

<h3>共享给我的同步目录</h3>
{% if in_repos %}
<table>
    <tr>
        <th width="25%">名字</th>
        <th width="20%">共享来源</th>
        <th width="25%">描述</th>
        <th width="20%">更新时间</th>
        <th width="10%">操作</th>
    </tr>

    {% for repo in in_repos %}
    <tr>
        <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}">{{ repo.props.name }}</a></td>
        <td>{{ repo.props.shared_email }}</td>
        <td>{{ repo.props.desc }}</td>
        {% if repo.latest_modify %}
        <td>{{ repo.latest_modify|translate_commit_time }}</td>
        {% else %}
        <td>—— ——</td>
        {% endif %}
        <td>
            <img src="{{ MEDIA_URL }}img/sync-20.png" data="{{ repo.props.id }}" class="download-btn vh" title="同步到本地" alt="同步" />
            <img src="{{ MEDIA_URL }}img/delete-20.png" data="{{ SITE_ROOT }}shareadmin/removeshare/?repo_id={{ repo.id }}&from={{ repo.shared_email }}&to={{ request.user }}" class="unshare-btn vh" title="取消共享" alt="取消共享" />
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>暂无</p>
{% endif %}

{% include "snippets/repo_share_form.html" %}
{% include "snippets/repo_create_form.html" %}

{% endblock %}

{% block extra_script %}
<script type="text/javascript">
{% include "snippets/myhome_extra_script.html" %}
</script>
{% endblock %}
