{% extends "admin_base.html" %}

{% load url from future %}

{% block nav_useradmin_class %}class="cur"{% endblock %}
{% block left_panel %}
<!--
<ul>
    <li><a href="{{ SITE_ROOT }}useradmin/add/">添加用户</a></li>
</ul>
-->
<div class="info-item">
<div class="info-item-top">
    <h3 class="inbl">已用空间</h3>
    <a href="#" class="set-quota op">设置容量</a>
</div>
<p class="info-item-bottom">{{ quota_usage|filesizeformat }} {% if quota > 0 %} / {{ quota|filesizeformat }} {% endif %}</p>
</div>

{% endblock %}

{% block right_panel %}
<h3>{{ email }} 拥有的资料库</h3>
{% if owned_repos %}
<table>
    <tr>
        <th width="4%"><!--icon--></th>
        <th width="30%">名字</th>
        <th width="46%">描述</th>
        <th width="20%">操作</th>
    </tr>

    {% for repo in owned_repos %}
    <tr>
        <td><img src="{{MEDIA_URL}}img/sync-folder-20.png" title="可读写" alt="目录icon" /></td>
        <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}/">{{ repo.props.name }}</a></td>
        <td>{{ repo.props.desc }}</td>
        <td>
        <a href="#" data="{{ SITE_ROOT }}repo/remove/{{ repo.props.id }}/?next={{ request.path }}" class="remove-user-repo op">删除</a>
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>暂无</p>
{% endif %}

<h3>共享给 {{ email }} 的资料库</h3>
{% if in_repos %}
<table>
    <tr>
        <th width="4%"><!--icon--></th>
        <th width="30%">名字</th>
        <th width="26%">共享来源</th>
        <th width="40%">描述</th>
    </tr>

    {% for repo in in_repos %}
    <tr>
        <td><img src="{{MEDIA_URL}}img/sync-folder-20.png" title="可读写" alt="目录icon" /></td>
        <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}">{{ repo.props.repo_name }}</a></td>
        <td>{{ repo.props.user }}</td>
        <td>{{ repo.props.repo_desc }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>暂无</p>
{% endif %}

<form id="set-quota-form" method="post" class="hide">{% csrf_token %}
    <label>设置该用户的存储容量上限</label><br />
    <input type="hidden" name="email" value="{{ email }}" />
    <input type="text" name="quota" /> MB <br />
    <p class="tip">Tip: 设置为0表示重置为默认上限</p>
    <p class="error hide"></p>
    <input type="submit" value="提交" class="submit" />
</form>

{% endblock %}


{% block extra_script %}
<script type="text/javascript">

$('.set-quota').click(function() {
    $("#set-quota-form").modal({appendTo: "#main"});
    return false;
});

$('#set-quota-form .submit').click(function() {
    var self = $(this);
    self.attr('disabled', 'disabled');
    $.ajax({
        url: '{% url 'views.user_info' email %}',
        type: 'POST',
        dataType: 'json',
        cache: 'false',
        beforeSend: prepareCSRFToken,
        data: {
            'email': $('#set-quota-form input[name="email"]').val(),
            'quota': $('#set-quota-form input[name="quota"]').val()
        },
        success: function(data) {
            if (data['success']) {
                location.reload(true);
            } else {
                apply_form_error('set-quota-form', data['error']);
                self.removeAttr('disabled');
            }
        },
        error: function(data, textStatus, jqXHR) {
            var errors = $.parseJSON(data.responseText);
            $.each(errors, function(index, value) {
                apply_form_error('set-quota-form', value[0]);
            });
            self.removeAttr('disabled');
        }
    });
    return false;
});

addConfirmTo($('.remove-user-repo'), '确定要删除该资料库？');

</script>
{% endblock %}
