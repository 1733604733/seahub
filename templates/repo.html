{% extends "myhome_base.html" %}
{% load seahub_tags %}

{% block main_panel %}
<div id="repo-page" class="ovhd">
    <h2>{{repo.props.name}}</h2>
    <div class="side fright">
        <p>{{repo.props.desc}}</p>
        <p>大小：{{ repo_size|filesizeformat }}</p>

        {% if not repo.props.encrypted %}
        {% if is_owner or repo_ap == 'public' or share_to_me %}
        <p class="latest-commit mgt10">
            {{ latest_commit.props.desc }}<br />
            <span class="author">by
            {% if latest_commit.props.creator_name %}
            {{ latest_commit.props.creator_name }}
            {% else %}
            未知
           {% endif %}
           </span>
           <span class="time">{{ latest_commit.props.ctime|tsstr_sec }}</span>
        </p>
        <a href="{{ SITE_ROOT }}repo/history/{{repo.props.id}}/" class="more">更多历史...</a>

        <p class="mgt10">
            <span class="item-name">WEB匿名访问:</span>
            {% if is_owner %}
                {% if repo_ap == 'public' %}
            <input type="checkbox" name="repo-access-switch" id="repo-access-switch" checked="checked" autocomplete="off" /><label for="repo-access-switch">开启</label>
                {% else %}
            <input type="checkbox" name="repo-access-switch" id="repo-access-switch" autocomplete="off" /><label for="repo-access-switch">开启</label>
                {% endif %}
            <br /><span class="tip">开启后，任何人都能够访问该目录</span>
            {% else %}
            <span>只有同步目录拥有者可设置</span>
            {% endif %}
        </p>
        {% endif %}
        {% endif %}
    </div>
    <div class="main fleft">
        {% if repo.props.encrypted %}
        <p>该同步目录已加密，不能在线查看。</p>
        {% else %}
            {% if not is_owner and repo_ap == 'own' and not share_to_me %}
            <p>该同步目录web匿名访问未开启，不能在线查看。</p>
            {% else %}
            <table class="repo-list">
                <tr>
                    <th width="60%">名字</th>
                    <th width="40%">操作</th>
                </tr>
     
                {% for dirent in dirs %}
                <tr>
                    {% if dirent.is_dir %}
                    <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}/?root_id={{ dirent.props.obj_id }}">{{ dirent.props.obj_name }}</a></td>
                    <td></td>
                    {% else %}
                    <td>{{ dirent.props.obj_name }}</td>
                    <td>
                        <button data="{{ SITE_ROOT }}repo/view/{{ repo.props.id }}/{{ dirent.props.obj_id }}/?file_name={{ dirent.props.obj_name }}" class="view-btn">查看</button>
                        <button data="{{ SITE_ROOT }}repo/download/{{ repo.props.id }}/{{ dirent.props.obj_id }}/?file_name={{ dirent.props.obj_name }}" class="download-btn">下载</button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </table>
            {% endif %}
        {% endif %}
    </div>
    <div id="public-access-start-confirm" class="hide">
        <p>确定要开启吗？</p>
        <button id="public-access-start-btn">确定</button>
        <button id="public-access-start-cancel-btn" class="simplemodal-close">取消</button>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script type="text/javascript">
if ($('#repo-access-switch').attr('checked')) {
    $('#repo-access-switch').click(function() {
        location.href = "{{ SITE_ROOT }}repo/setap/{{ repo.props.id}}/?ap=own";
    });
} else {
    $('#repo-access-switch').click(function() {
        $('#public-access-start-confirm').modal({appendTo:"#main", containerCss:{padding:18}});
    });
}

$('#public-access-start-btn').click(function() {
    location.href = "{{ SITE_ROOT }}repo/setap/{{ repo.props.id}}/?ap=public";
});
$('#public-access-start-cancel-btn').click(function() {
    $('#repo-access-switch').attr('checked', false);
});

$('.view-btn').click(function() {
    location.href = $(this).attr('data');
});
</script>
{% endblock %}
