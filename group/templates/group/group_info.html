{% extends "myhome_base.html" %}
{% load seahub_tags avatar_tags %}

{% block nav_group_class %}class="cur"{% endblock %}

{% block main_panel %}
<h2>{{ group.group_name }}</h2>
<div class="side fright">
<h3>管理员</h3>
<ul>
{% for member in managers %}
    <li class="group-member">{% avatar member.user_name 16 %}<a class="group-member-name" href="{{ SITE_ROOT }}profile/{{ member.user_name }}/">{{ member.user_name|email2nickname }}</a></li>
{% endfor %}
</ul>

<h3>成员</h3>
{% if common_members %}
<ul>
    {% for member in common_members %}
    <li class="group-member">{% avatar member.user_name 16 %}<a class="group-member-name" href="{{ SITE_ROOT }}profile/{{ member.user_name }}/">{{ member.user_name|email2nickname }}</a></li>
    {% endfor %}
</ul>
{% else %}
<p>暂无</p>
{% endif %}

{% if is_join %}
<h3>操作</h3>
<ul class="with-bg">
{% if is_staff %}
    <li><a id="group-mgr" href="{{ SITE_ROOT }}group/{{ group.id }}/members/">小组管理</a></li>
{% else %}
	<li><a id="quit-group" href="#" data="{{ SITE_ROOT }}group/{{ group.id }}/?op=quit">退出小组</a></li>
{% endif %}
</ul>
{% endif %}

</div>

<div class="main fleft">
<h3>小组里共享的同步目录</h3>
{% if repos %}
<table>
    <tr>
        <th width="20%">名字</th>
        <th width="48%">描述</th>
        <th width="22%">共享来源</th>
        <th width="10%">操作</th>
    </tr>

    {% for repo in repos %}
    <tr>
        <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}/">{{ repo.props.name }}</a></td>
        <td>{{ repo.props.desc }}</td>
        <td>{{ repo.share_from }}</td>
        <td>
            <img src="{{ MEDIA_URL }}img/download-20.png" class="download vh" data="{{ SITE_ROOT }}seafile_access_check/?repo_id={{ repo.props.id }}" alt="下载" title="下载" />
        {% if is_staff or repo.share_from_me  %}
            <img src="{{ MEDIA_URL }}img/delete-20.png" class="cancel-share vh" data="{{ SITE_ROOT }}shareadmin/removeshare/?repo_id={{ repo.props.id }}&from={{ repo.share_from }}&gid={{ group.id }}" title="取消共享" alt="取消共享" />
        {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>暂无</p>
{% endif %}

<div id="group-reply">
<h3>留言板 （全部{{ msg_cnt }}条）</h3>
<form action="" method="post">
  <textarea name="message" id="message">{{ form.data.message }}</textarea><br />
  <input type="submit" value="留言" class="submit" />  
  {% for error in form.message.errors %}
  <span class="error">{{ error|escape }}</span>
  {% endfor %}
</form>

{% if group_msgs %}
<ul class="replies">
  {% for msg in group_msgs %}
  
  {% avatar msg.from_email 48 %}
  
  <li id="li{{ msg.id }}">
    <span class="from">
    {{ msg.from_email }}
    </span>
    
    <span class="ts">
    {{ msg.timestamp|date:"Y-m-d H:i" }}
    </span>
    
    <div class="msg-op">
      <span class="msg">{{ msg.message }}</span>
      <span>
        <a class="op reply" href="#" data="{{ msg.id }}" >回复（{{ msg.reply_cnt }}）</a>
        <a class="op replyclose" href="#" data="{{ msg.id }}" style="display:none; " >收起回复</a>        
      </span>
    </div>
    
    <div class="reply-list"></div>
    
    <form class="hide reply-form" method="post" action="">
      <input type="hidden" name="msg_id" value="{{ msg.id }}"/>
      <input type="text" name="message" />
      <input type="submit" value="回复" />
    </form>
  </li>
  {% endfor %}
</ul>
{% endif %}
</div>

<div id="paginator">
    {% if current_page != 1 %}
    <a href="{{ SITE_ROOT }}group/{{ group.id}}/?page={{ prev_page }}&per_page={{ per_page }}">上一页</a>
    {% endif %}
    {% if page_next %}
    <a href="{{ SITE_ROOT }}group/{{ group.id }}/?page={{ next_page }}&per_page={{ per_page }}">下一页</a>
    {% endif %}
</div>

</div>

<div id="user-profile" class="user-profile ovhd hide"></div>
<textarea id="jtemplate" class="hide">
{#if !$T.err_msg}
<div class="pic fleft">
    <img class="avatar" width="80" height="80" alt="{$T.email}" />
    {#if $T.new_user}
    <button id="add-as-contact">加为联系人</button>
    {#/if}
</div>

<div class="txt fright">
    {#if $T.user_nickname}
    <p>{$T.user_nickname}</p>
    {#/if}

    <p>{$T.email}</p>

    {#if $T.user_intro}
    <p class="intro">{$T.user_intro}</p>
    {#/if}
</div>

{#if $T.new_user}
<form id="add-as-contact-form" class="hide" action="{{ SITE_ROOT }}contacts/add/" method="post">
    <input type="hidden" name="user_email" value="{{ request.user.username }}" id="id_user_email" />
    <label>邮箱：</label><br />
    <input id="id_contact_email" type="text" name="contact_email" maxlength="255" value="{$T.email}" /><br />
    <label>名字(可选)：</label><br />
    <input id="id_contact_name" type="text" name="contact_name" maxlength="255" /><br />
    <label>备注(可选)：</label><br />
    <input id="id_note" type="text" name="note" maxlength="255" /><br />
    <input type="submit" value="提交"  class="submit" />
</form>
{#/if}

{#else}
<p class="error">{$T.err_msg}</p>
{#/if}

</textarea>

{% endblock %}

{% block extra_script %}
<script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-jtemplates.js"></script>
<script type="text/javascript">
    addConfirmTo($('#quit-group'), '确定要退出？');
    addConfirmTo($('.cancel-share'), '确定要取消共享该目录？');

    $("table tr:gt(0)").hover(
        function() {
            $(this).find('img').css('cursor', 'pointer').removeClass('vh');
        },
        function() {
            $(this).find('img').addClass('vh');
        }
    );

    $('.download').click(function() {
        window.open($(this).attr('data'));
    });

//show profile when  mouse over
var Hide_profile = '';
$('.group-member').hover(
    function() {
        var this_top = $(this).offset().top - $('#main').offset().top;
        $(this).css('background', '#eee');
        var avatar_url = $(this).children('.avatar').attr('src'),
            avatar_url_array = avatar_url.split('/');
        if (avatar_url_array.length > 4) {//not default avatar
            avatar_url_array[5] = 80;//choose avatar size 
            avatar_url = avatar_url_array.join('/');
        }
        $.ajax({
            url: $(this).children('.group-member-name').attr('href') + 'get/',
            dataType: 'json',
            cache: false,
            contentType: 'application/json; charset=utf-8',
            success: function(data) {
                $('#user-profile').setTemplateElement('jtemplate').processTemplate(data);
                $('#user-profile .avatar').attr('src', avatar_url);
                $('#user-profile').removeClass('hide');
                $('#main').css('position', 'relative');
                $('#add-as-contact').click(function() {
                    $('#add-as-contact-form').modal({appendTo: '#main'});
                });
                if (this_top + $('#user-profile').height() < $('#main').height()) {
                    $('#user-profile').css('top', this_top - 10);
                } else {
                    $('#user-profile').css('top', $('#main').height() - $('#user-profile').height() - 5);
                }
            }
        });
        clearTimeout(Hide_profile);
    },
    function() {
        $(this).css('background', '#fff');
        Hide_profile = setTimeout(function() { $('#user-profile').addClass('hide'); }, 3000);
    }
);

$('#user-profile').hover(
    function() {
        clearTimeout(Hide_profile);
    },
    function() {
        $(this).addClass('hide');
    }
);

    $('.reply').each(function() {
        $(this).click(function() {
            var msg_id = $(this).attr('data');
            $.ajax({
                url: "{{ SITE_ROOT }}group/reply/"+msg_id+"/",
                dataType: 'json',
                cache: false,
                contentType: 'application/json; charset=utf-8',
                success: function(data) {
                    var str_con = '';
                    var show = function(data_) {
                        for (var i = 0, len = data_.length; i < len; i++) {
                            var msg = data_[i]['fields']['message'];
                            str_con += '<p>';
                            str_con += msg;
                            str_con += '</p>';
                        }
                    };
                    show(data);
                    var s = '#li' + msg_id + ' > .reply-list';
                    var s1 = '#li' + msg_id + ' > form';
                    $(s).html(str_con);
                    $(s).show();
                    $(s1).removeClass('hide');
                }
            });
            $(this).hide();
            
            var s3 = '#li' + msg_id + ' a~a';
            $(s3).show();
            
            return false;
        });
    });

    $('.replyclose').each(function() {
        $(this).click(function() {
            var msg_id = $(this).attr('data');
            var s1 = '#li' + msg_id + ' a';
            var s2 = '#li' + msg_id + ' > .reply-list';
            var s3 = '#li' + msg_id + ' > form';
            var s4 = '#li' + msg_id + ' a~a';

            $(s2).hide();
            $(s3).addClass('hide');
            $(s1).show();
            $(s4).hide();
            return false;
        });
    });
    
    $('.reply-form').each(function(){
        $(this).submit(function(event) {
            // prepare django csrf token
            $.ajaxSetup({ 
                beforeSend: function(xhr, settings) {
                    function getCookie(name) {
                        var cookieValue = null;
                        if (document.cookie && document.cookie != '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = jQuery.trim(cookies[i]);
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                            }
                         }
                         }
                         return cookieValue;
                    }
                    if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                    }
                } 
            });

            var $form = $( this ),
                m_id = $form.find( 'input[name="msg_id"]' ).val(),
                m = $form.find( 'input[name="message"]' ).val();

            $.ajax({
                type: "POST",
                url: "{{ SITE_ROOT }}group/reply/"+m_id+"/",
                dataType: 'json',
                cache: false,
                contentType: 'application/json; charset=utf-8',
                data: "message="+m,
                success: function(data) {

                    var str_con = '';
                    var show = function(data_) {
                        for (var i = 0, len = data_.length; i < len; i++) {
                            var msg = data_[i]['fields']['message'];
                            str_con += '<p>';
                            str_con += msg;
                            str_con += '</p>';
                        }
                    };
                    show(data);
                    var s = '#li' + m_id + ' > .reply-list';
                    var s1 = '#li' + m_id + ' > form';
                    $(s1).removeClass('hide');
                    $(s).html(str_con);

                    var s2 = '#li' + m_id + ' .reply';
                    var t = '回复（' + data.length+ '）';
                    $(s2).text(t);
                    $form.find('input[name="message"]').val("");
                }
            });
            return false;
        });
    });
</script>
{% endblock %}
