{% extends base_template %}

{% load seahub_tags avatar_tags %}
{% load url from future %}

{% block nav_group_class %}class="cur"{% endblock %}

{% block main_panel %}
{% if messages %}
<ul class="messages hide">
    {% for message in messages %}
    <li class="info">{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<h2>{{ group.group_name }}</h2>

<div class="side fright">
<h3>管理员</h3>
<ul>
{% for member in managers %}
    <li class="group-member">{% avatar member.user_name 16 %}<a class="group-member-name" href="{{ SITE_ROOT }}profile/{{ member.user_name }}/">{{ member.user_name|email2nickname }}</a></li>
{% endfor %}
</ul>

<h3>成员</h3>
{% if common_members %}
<ul>
    {% for member in common_members %}
    <li class="group-member">{% avatar member.user_name 16 %}<a class="group-member-name" href="{{ SITE_ROOT }}profile/{{ member.user_name }}/">{{ member.user_name|email2nickname }}</a></li>
    {% endfor %}
</ul>
{% else %}
<p>暂无</p>
{% endif %}

{% if is_join %}
<h3>操作</h3>
<ul class="with-bg">
{% if is_staff %}
    <li><a id="group-mgr" href="{{ SITE_ROOT }}group/{{ group.id }}/members/">小组管理</a></li>
{% else %}
	<li><a id="quit-group" href="#" data="{{ SITE_ROOT }}group/{{ group.id }}/?op=quit">退出小组</a></li>
{% endif %}
</ul>
{% endif %}

</div>

<div class="main fleft">
<h3>小组里共享的同步目录</h3>
<button id="repo-create">新建同步目录</button>
{% if repos %}
<table>
    <tr>
        <th width="20%">名字</th>
        <th width="40%">描述</th>
        <th width="15%">更新时间</th>
        <th width="15%">共享来源</th>
        <th width="10%">操作</th>
    </tr>

    {% for repo in repos %}
    <tr>
        <td><a href="{{ SITE_ROOT }}repo/{{ repo.props.id }}/">{{ repo.props.name }}</a></td>
        <td>{{ repo.props.desc }}</td>
        {% if repo.latest_modify %}
        <td>{{ repo.latest_modify|translate_commit_time }}</td>
        {% else %}
        <td>—— ——</td>
        {% endif %}
        <td>{{ repo.owner|email2nickname }}</td>
        <td>
            <img src="{{ MEDIA_URL }}img/sync-20.png" class="download vh" data="{{ SITE_ROOT }}seafile_access_check/?repo_id={{ repo.props.id }}" alt="同步" title="同步到本地" />
        {% if is_staff or repo.share_from_me  %}
            <img src="{{ MEDIA_URL }}img/delete-20.png" class="cancel-share vh" data="{{ SITE_ROOT }}shareadmin/removeshare/?repo_id={{ repo.props.id }}&from={{ repo.owner }}&gid={{ group.id }}" title="取消共享" alt="取消共享" />
        {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>暂无</p>
{% endif %}

<div id="group-reply">
    <h3>信息栏</h3>
    <form id="group-message-form" action="" method="post">
        <textarea name="message" id="message">{{ form.data.message }}</textarea><br />
        {% for error in form.message.errors %}
        <p class="error">{{ error|escape }}</p>
        {% endfor %}
        <input type="submit" value="提交" class="submit" />
    </form>

{% if group_msgs %}
    <ul class="msg-list">
    {% for msg in group_msgs %}
        <li class="msg w100 ovhd">
        <div class="pic fleft">
            <a href="{{ SITE_ROOT }}profile/{{ msg.from_email }}/">{% avatar msg.from_email 48 %}</a>
        </div>
        <div class="txt fright">
            <div class="msg-hd">
                <span class="time">{{ msg.timestamp|translate_commit_time }}</span>
                <a href="{{ SITE_ROOT }}profile/{{ msg.from_email }}/" title="{{ msg.from_email }}">{{ msg.from_email|email2nickname }}</a>
            </div>
            <div class="msg-bd">
                <p>
                {% if msg.attachment.src == 'recommend' %}
                <!-- recommend -->
                <span class="recommend">推荐
                  {% if msg.attachment.attach_type == 'file' %}
                  <a href="{% url 'repo_view_file' msg.attachment.repo_id %}?p={{ msg.attachment.path|urlencode }}" target="_blank">
                  {% else %}
                  <a href="{% url 'repo' msg.attachment.repo_id %}?p={{ msg.attachment.path|urlencode }}" target="_blank">
                  {% endif %}
                  {{ msg.attachment.name }}</a> :
                </span>
                {% endif %}

                {% if msg.attachment.src == 'filecomment' %}
                <!-- file comment -->
                <span class="recommend">文件 <a href="{% url 'repo_view_file' msg.attachment.repo_id %}?p={{ msg.attachment.path|urlencode }}" target="_blank"> {{ msg.attachment.name }}</a> 有新的评注：</span>
                {% endif %}
                
                {{ msg.message|seahub_urlize|find_at|linebreaksbr }}
                </p>
                <button class="reply op" data="{{ msg.id }}"><span class="reply-cnt">{% if msg.reply_cnt != 0 %}{{ msg.reply_cnt }} {% endif %}</span>回复</button>
                <button class="replyclose op hide">收起回复</button>
                <div class="reply-bd"></div>
            </div>
        </div>
        </li>
    {% endfor %}
    </ul>
{% endif %}

    <div id="paginator">
        {% if current_page != 1 %}
        <a href="{{ SITE_ROOT }}group/{{ group.id}}/?page={{ prev_page }}&per_page={{ per_page }}">上一页</a>
        {% endif %}
        {% if page_next %}
        <a href="{{ SITE_ROOT }}group/{{ group.id }}/?page={{ next_page }}&per_page={{ per_page }}">下一页</a>
        {% endif %}
    </div>
</div>
</div>

<div id="user-profile" class="user-profile ovhd hide"></div>
<textarea id="jtemplate" class="hide">
{#if !$T.err_msg}
<div class="pic fleft">
    <img class="avatar" width="80" height="80" alt="{$T.email}" />
    {#if $T.new_user}
    <button id="add-as-contact">加为联系人</button>
    {#/if}
</div>

<div class="txt fright">
    {#if $T.user_nickname}
    <p>{$T.user_nickname}</p>
    {#/if}

    <p>{$T.email}</p>

    {#if $T.user_intro}
    <p class="intro">{$T.user_intro}</p>
    {#/if}
</div>

{#if $T.new_user}
<form id="add-as-contact-form" class="hide" action="{{ SITE_ROOT }}contacts/add/?group_id={{ group.id }}" method="post">
    <input type="hidden" name="user_email" value="{{ request.user.username }}" id="id_user_email" />
    <label>邮箱：</label><br />
    <input id="id_contact_email" type="text" name="contact_email" maxlength="255" value="{$T.email}" /><br />
    <label>名字(可选)：</label><br />
    <input id="id_contact_name" type="text" name="contact_name" maxlength="255" /><br />
    <label>备注(可选)：</label><br />
    <input id="id_note" type="text" name="note" maxlength="255" /><br />
    <input type="submit" value="提交"  class="submit" />
</form>
{#/if}

{#else}
<p class="error">{$T.err_msg}</p>
{#/if}

</textarea>

{% include "snippets/repo_create_form.html" %}

{% endblock %}

{% block extra_script %}
<script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-jtemplates.js"></script>
<script type="text/javascript">
addConfirmTo($('#quit-group'), '确定要退出？');
addConfirmTo($('.cancel-share'), '确定要取消共享该目录？');

$(function() {
    var member_list = [], nickname, pinyin;
    {% for member in members %}
    nickname = '{{ member.user_name|email2nickname }}';
    pinyin = '{{ member.user_name|email2nickname|char2pinyin }}';
    member_list.push({value:nickname + pinyin, label:nickname});
    {% endfor %}
    addAtAutocomplete('#message', '#group-message-form', member_list, {'border':'1px solid #ddd', 'width':'600px', 'height': '80px', 'word-wrap':'break-word', 'overflow-y':'auto', 'line-height': '1.5em'}); // remember to add unit (px or em) to line-height, as js in ie will take 1.5 as 1.5, not 1.5em
});

$("table tr:gt(0)").hover(
    function() {
        $(this).find('img').css('cursor', 'pointer').removeClass('vh');
    },
    function() {
        $(this).find('img').addClass('vh');
    }
);

$('.download').click(function() {
    window.open($(this).attr('data'));
});

//show profile when mouse over
var Hide_profile = '';
$('.group-member').hover(
    function() {
        var this_top = $(this).offset().top - $('#main').offset().top;
        $(this).css('background', '#eee');
        var avatar_url = $(this).children('.avatar').attr('src'),
            avatar_url_array = avatar_url.split('/');
        if (avatar_url_array[avatar_url_array.length-2] == 16) {//not default avatar
            avatar_url_array[avatar_url_array.length-2] = 80;//choose avatar size 
            avatar_url = avatar_url_array.join('/');
        }
        $.ajax({
            url: $(this).children('.group-member-name').attr('href') + 'get/',
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function(data) {
                $('#user-profile').setTemplateElement('jtemplate').processTemplate(data);
                $('#user-profile .avatar').attr('src', avatar_url);
                $('#user-profile').removeClass('hide');
                $('#main').css('position', 'relative');
                $('#add-as-contact').click(function() {
                    //$('#add-as-contact-form').modal({appendTo: '#main'});
                    $('#add-as-contact-form')[0].submit();
                });
                if (this_top + $('#user-profile').height() < $('#main').height()) {
                    $('#user-profile').css('top', this_top - 10);
                } else {
                    $('#user-profile').css('top', $('#main').height() - $('#user-profile').height() - 5);
                }
            }
        });
        clearTimeout(Hide_profile);
    },
    function() {
        $(this).css('background', '#fff');
        Hide_profile = setTimeout(function() { $('#user-profile').addClass('hide'); }, 1000);
    }
);

$('#user-profile').hover(
    function() {
        clearTimeout(Hide_profile);
    },
    function() {
        $(this).addClass('hide');
    }
);
{% include 'group/msg_reply_js.html' %}

{% url 'create_group_repo' group.id as repo_create_url %}
{% with post_url=repo_create_url %}
{% include 'snippets/repo_create_js.html' %}
{% endwith %}
</script>
{% endblock %}
